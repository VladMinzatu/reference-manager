<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reference Manager</title>
    <script src="https://unpkg.com/htmx.org@1.9.4"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        /* Remove old CSS, now using Tailwind */
        .category-link.active { font-weight: bold; }
    </style>
    <script>
        function initCategoryReorder() {
          var el = document.getElementById('category-list');
          console.log('initCategoryReorder called, element:', el);
          if (el && window.Sortable) {
            if (el._sortableInstance) {
              el._sortableInstance.destroy();
            }
            el._sortableInstance = new Sortable(el, {
              animation: 150,
              handle: '.category-link',
              onEnd: function (evt) {
                var positions = {};
                el.querySelectorAll('.category-row').forEach(function(row, idx) {
                  positions[row.getAttribute('data-id')] = idx;
                });
                
                // Find the currently active category
                var activeLink = el.querySelector('.category-link.active');
                var activeCategoryId = activeLink ? activeLink.getAttribute('data-category-id') : null;
                
                var values = { positions: JSON.stringify(positions) };
                if (activeCategoryId) {
                  values.activeCategoryId = activeCategoryId;
                }
                
                htmx.ajax('PUT', '/categories/reorder', {
                  values: values,
                  target: '#sidebar',
                  swap: 'outerHTML',
                  onError: function() {
                    htmx.ajax('GET', '/sidebar', { target: '#sidebar', swap: 'outerHTML' });
                  }
                });
              }
            });
            console.log('SortableJS initialized on category-list');
          } else {
            console.log('SortableJS not available or element not found');
          }
        }
        
        // Initialize on initial page load
        document.addEventListener('DOMContentLoaded', function() {
          // Clean up before sidebar swaps
          document.body.addEventListener('htmx:beforeSwap', function(evt) {
            if (evt.detail.target && (evt.detail.target.id === 'sidebar' || evt.detail.target.id === 'body-fragment')) {
              var el = document.getElementById('category-list');
              if (el && el._sortableInstance) {
                el._sortableInstance.destroy();
              }
            }
          });
          
          // Initialize after sidebar swaps
          document.body.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail.target && (evt.detail.target.id === 'sidebar' || evt.detail.target.id === 'body-fragment')) {
              initCategoryReorder();
            }
          });
          
          // Initialize on page load
          initCategoryReorder();
        });
    </script>
</head>

<body>
    {{template "body-fragment" .}}
</body>
</html>

{{define "body-fragment"}}
<div id="body-fragment" class="bg-gray-50 min-h-screen flex">
    {{template "sidebar" .sidebar}}
    <div id="main" class="flex-1 p-8">
        {{template "references" .references}}
    </div>
</div>
{{end}}